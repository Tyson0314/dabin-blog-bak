<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简介 | 程序员大彬</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
			var _hmt = _hmt || [];
			(function() {
				var hm = document.createElement("script");
				hm.src = "https://hm.baidu.com/hm.js?f9b36644dd9e756e508a77f272a63e07";
				var s = document.getElementsByTagName("script")[0];
				s.parentNode.insertBefore(hm, s);
			})();
		</script>
    <meta name="description" content="自学转码之路">
    <meta name="baidu-site-verification" content="code-mtJaPDeFwy">
    
    <link rel="preload" href="/assets/css/0.styles.b00f5641.css" as="style"><link rel="preload" href="/assets/js/app.8b2696d1.js" as="script"><link rel="preload" href="/assets/js/2.d0db0f62.js" as="script"><link rel="preload" href="/assets/js/44.9d432355.js" as="script"><link rel="preload" href="/assets/js/4.23f6297f.js" as="script"><link rel="preload" href="/assets/js/3.1924df35.js" as="script"><link rel="prefetch" href="/assets/js/10.b9d2c267.js"><link rel="prefetch" href="/assets/js/11.a9536795.js"><link rel="prefetch" href="/assets/js/12.637e3c09.js"><link rel="prefetch" href="/assets/js/13.102d093f.js"><link rel="prefetch" href="/assets/js/14.d7307789.js"><link rel="prefetch" href="/assets/js/15.18bb96a8.js"><link rel="prefetch" href="/assets/js/16.1b890605.js"><link rel="prefetch" href="/assets/js/17.25ef6a92.js"><link rel="prefetch" href="/assets/js/18.fa185cc7.js"><link rel="prefetch" href="/assets/js/19.499be2f4.js"><link rel="prefetch" href="/assets/js/20.08f6b86d.js"><link rel="prefetch" href="/assets/js/21.40cb96ce.js"><link rel="prefetch" href="/assets/js/22.2c42b78a.js"><link rel="prefetch" href="/assets/js/23.15469153.js"><link rel="prefetch" href="/assets/js/24.7f6b0e2a.js"><link rel="prefetch" href="/assets/js/25.cbd85eeb.js"><link rel="prefetch" href="/assets/js/26.1ad15ebe.js"><link rel="prefetch" href="/assets/js/27.4eba854b.js"><link rel="prefetch" href="/assets/js/28.e509fb9b.js"><link rel="prefetch" href="/assets/js/29.994dbd5a.js"><link rel="prefetch" href="/assets/js/30.18c1aefb.js"><link rel="prefetch" href="/assets/js/31.c38796f9.js"><link rel="prefetch" href="/assets/js/32.88ef97b8.js"><link rel="prefetch" href="/assets/js/33.a4dfb656.js"><link rel="prefetch" href="/assets/js/34.6de68068.js"><link rel="prefetch" href="/assets/js/35.4a8cdbbc.js"><link rel="prefetch" href="/assets/js/36.0e932c72.js"><link rel="prefetch" href="/assets/js/37.38759ff6.js"><link rel="prefetch" href="/assets/js/38.d822e272.js"><link rel="prefetch" href="/assets/js/39.de685084.js"><link rel="prefetch" href="/assets/js/40.ad41558b.js"><link rel="prefetch" href="/assets/js/41.b01fca4f.js"><link rel="prefetch" href="/assets/js/42.c1253a77.js"><link rel="prefetch" href="/assets/js/43.d2f61e81.js"><link rel="prefetch" href="/assets/js/45.0418c1c2.js"><link rel="prefetch" href="/assets/js/46.184f9783.js"><link rel="prefetch" href="/assets/js/47.569f10e6.js"><link rel="prefetch" href="/assets/js/48.c1409476.js"><link rel="prefetch" href="/assets/js/49.6ad0d80a.js"><link rel="prefetch" href="/assets/js/5.3354b992.js"><link rel="prefetch" href="/assets/js/50.bfb92a00.js"><link rel="prefetch" href="/assets/js/51.0cbece85.js"><link rel="prefetch" href="/assets/js/52.add1c509.js"><link rel="prefetch" href="/assets/js/53.57ff55f5.js"><link rel="prefetch" href="/assets/js/54.b79fd09c.js"><link rel="prefetch" href="/assets/js/55.ac4d7936.js"><link rel="prefetch" href="/assets/js/56.66b9e3ef.js"><link rel="prefetch" href="/assets/js/57.e70bf088.js"><link rel="prefetch" href="/assets/js/58.ae1694e7.js"><link rel="prefetch" href="/assets/js/59.5a99d3b1.js"><link rel="prefetch" href="/assets/js/6.6f03b31d.js"><link rel="prefetch" href="/assets/js/60.5f4f38b4.js"><link rel="prefetch" href="/assets/js/61.9d742e56.js"><link rel="prefetch" href="/assets/js/62.670b09f0.js"><link rel="prefetch" href="/assets/js/63.f9f8adca.js"><link rel="prefetch" href="/assets/js/64.aa6ede7d.js"><link rel="prefetch" href="/assets/js/65.5202a37e.js"><link rel="prefetch" href="/assets/js/66.ecb7cc6a.js"><link rel="prefetch" href="/assets/js/67.b08a5c76.js"><link rel="prefetch" href="/assets/js/68.502d67dd.js"><link rel="prefetch" href="/assets/js/69.c5041e73.js"><link rel="prefetch" href="/assets/js/7.77e90ab1.js"><link rel="prefetch" href="/assets/js/70.cd2342e1.js"><link rel="prefetch" href="/assets/js/71.9f448730.js"><link rel="prefetch" href="/assets/js/72.098efb15.js"><link rel="prefetch" href="/assets/js/73.da7342aa.js"><link rel="prefetch" href="/assets/js/74.98f3211b.js"><link rel="prefetch" href="/assets/js/75.4e6ffa8f.js"><link rel="prefetch" href="/assets/js/8.8d940901.js"><link rel="prefetch" href="/assets/js/9.dc8d7aad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b00f5641.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">程序员大彬</span></a> <nav class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="nav-links can-hide"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>主页</span></a></li><li class="nav-item"><a href="https://docs.qq.com/sheet/DYW9ObnpobXNRTXpq" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>​秋招来啦（内推）</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/java-basic.html" class="nav-link"><!----> <span>基础</span></a></li><li class="dropdown-item"><!----> <a href="/java/java-collection.html" class="nav-link"><!----> <span>集合</span></a></li><li class="dropdown-item"><!----> <a href="/java/java-concurrent.html" class="nav-link"><!----> <span>并发</span></a></li><li class="dropdown-item"><!----> <a href="/java/jvm.html" class="nav-link"><!----> <span>JVM</span></a></li><li class="dropdown-item"><!----> <a href="/java/java8.html" class="nav-link"><!----> <span>Java8新特性</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架中间件" class="dropdown-title"><!----> <span class="title">
      框架中间件
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="框架中间件" class="mobile-dropdown-title"><!----> <span class="title">框架中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/spring.html" class="nav-link"><!----> <span>Spring面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springmvc.html" class="nav-link"><!----> <span>SpringMVC面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/mybatis.html" class="nav-link"><!----> <span>Mybatis面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springboot.html" class="nav-link"><!----> <span>SpringBoot面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springcloud-overview.html" class="nav-link"><!----> <span>SpringCloud详解</span></a></li><li class="dropdown-subitem"><a href="/framework/netty-overview.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><!----> <span>Netty详解</span></a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/message-queue/mq.html" class="nav-link"><!----> <span>消息队列面试题</span></a></li><li class="dropdown-subitem"><a href="/message-queue/rabbitmq.html" class="nav-link"><!----> <span>RabbitMQ面试题</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><!----> <span class="title">
      计算机基础
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><!----> <span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/computer-basic/network.html" class="nav-link"><!----> <span>网络</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/operate-system.html" class="nav-link"><!----> <span>操作系统</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/algorithm.html" class="nav-link"><!----> <span>算法</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/data-structure.html" class="nav-link"><!----> <span>数据结构</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title">
      数据库
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><!----> <span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/mysql-basic/" class="nav-link"><!----> <span>MySQL基础</span></a></li><li class="dropdown-subitem"><a href="/database/mysql.html" class="nav-link"><!----> <span>MySQL面试题</span></a></li><li class="dropdown-subitem"><a href="/database/mysql-execution-plan.html" class="nav-link"><!----> <span>MySQL执行计划详解</span></a></li></ul></li><li class="dropdown-item"><h4>
          非关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/redis-basic.html" class="nav-link"><!----> <span>Redis基础</span></a></li><li class="dropdown-subitem"><a href="/redis/redis.html" class="nav-link"><!----> <span>Redis面试题</span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/Ffb8NDgavf9QAWYBm0qAVg" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>ElasticSearch面试题</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><!----> <span class="title">
      分布式
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><!----> <span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/global-unique-id.html" class="nav-link"><!----> <span>全局唯一ID</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/distributed-lock.html" class="nav-link"><!----> <span>分布式锁</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/rpc.html" class="nav-link"><!----> <span>RPC</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/micro-service.html" class="nav-link"><!----> <span>微服务</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/distributed-transaction.html" class="nav-link"><!----> <span>分布式事务</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程内功" class="dropdown-title"><!----> <span class="title">
      编程内功
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="编程内功" class="mobile-dropdown-title"><!----> <span class="title">编程内功</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advance/design-pattern.html" class="nav-link"><!----> <span>设计模式</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="场景题&amp;系统设计" class="dropdown-title"><!----> <span class="title">
      场景题&amp;系统设计
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="场景题&amp;系统设计" class="mobile-dropdown-title"><!----> <span class="title">场景题&amp;系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          海量数据
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mass-data/count-phone-num.html" class="nav-link"><!----> <span>统计不同号码的个数</span></a></li><li class="dropdown-subitem"><a href="/mass-data/find-hign-frequency-word.html" class="nav-link"><!----> <span>出现频率最高的100个词</span></a></li></ul></li><li class="dropdown-item"><h4>
          系统设计
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/system-design/scan-code-login.html" class="nav-link"><!----> <span>扫码登录设计</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title">
      工具
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><!----> <span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          开发工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/tools/git-overview.html" class="nav-link"><!----> <span>Git详解</span></a></li><li class="dropdown-subitem"><a href="/tools/maven-overview.html" class="nav-link"><!----> <span>Maven详解</span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/ATkZwtw4EF9erGJ4PamTjQ" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Docker详解</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/SKKEeYxif0wWJo6n57rd6A" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Nginx面试题</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/GbTaa3_qs1KvgUD3S2307w" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Linux常用命令</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          编程利器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/tools/typora-overview.html" class="nav-link"><!----> <span>markdown编辑器</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习资源" class="dropdown-title"><!----> <span class="title">
      学习资源
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="学习资源" class="mobile-dropdown-title"><!----> <span class="title">学习资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          学习资源
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/Tyson0314/java-books" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>计算机经典电子书PDF</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="/learning-resources/leetcode-note.html" class="nav-link"><!----> <span>Leetcode刷题笔记</span></a></li></ul></li><li class="dropdown-item"><h4>
          学习路线
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/learning-resources/java-learn-guide.html" class="nav-link"><!----> <span>Java学习路线</span></a></li><li class="dropdown-subitem"><a href="/learning-resources/cs-learn-guide.html" class="nav-link"><!----> <span>CS学习路线</span></a></li></ul></li></ul></div></li><li class="nav-item"><a href="/other/site-diary.html" class="nav-link"><!----> <span>网站日记</span></a></li> <li class="nav-item"><a href="undefinedundefined/" target="_blank" rel="noopener noreferrer"><!----> <span></span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="theme-switcher"><a class="switch light"><span><i aria-hidden="true" class="fa fa-sun"></i></span></a></div></nav></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <ul class="nav-links"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>主页</span></a></li><li class="nav-item"><a href="https://docs.qq.com/sheet/DYW9ObnpobXNRTXpq" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>​秋招来啦（内推）</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/java-basic.html" class="nav-link"><!----> <span>基础</span></a></li><li class="dropdown-item"><!----> <a href="/java/java-collection.html" class="nav-link"><!----> <span>集合</span></a></li><li class="dropdown-item"><!----> <a href="/java/java-concurrent.html" class="nav-link"><!----> <span>并发</span></a></li><li class="dropdown-item"><!----> <a href="/java/jvm.html" class="nav-link"><!----> <span>JVM</span></a></li><li class="dropdown-item"><!----> <a href="/java/java8.html" class="nav-link"><!----> <span>Java8新特性</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架中间件" class="dropdown-title"><!----> <span class="title">
      框架中间件
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="框架中间件" class="mobile-dropdown-title"><!----> <span class="title">框架中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/spring.html" class="nav-link"><!----> <span>Spring面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springmvc.html" class="nav-link"><!----> <span>SpringMVC面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/mybatis.html" class="nav-link"><!----> <span>Mybatis面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springboot.html" class="nav-link"><!----> <span>SpringBoot面试题</span></a></li><li class="dropdown-subitem"><a href="/framework/springcloud-overview.html" class="nav-link"><!----> <span>SpringCloud详解</span></a></li><li class="dropdown-subitem"><a href="/framework/netty-overview.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><!----> <span>Netty详解</span></a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/message-queue/mq.html" class="nav-link"><!----> <span>消息队列面试题</span></a></li><li class="dropdown-subitem"><a href="/message-queue/rabbitmq.html" class="nav-link"><!----> <span>RabbitMQ面试题</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><!----> <span class="title">
      计算机基础
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><!----> <span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/computer-basic/network.html" class="nav-link"><!----> <span>网络</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/operate-system.html" class="nav-link"><!----> <span>操作系统</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/algorithm.html" class="nav-link"><!----> <span>算法</span></a></li><li class="dropdown-item"><!----> <a href="/computer-basic/data-structure.html" class="nav-link"><!----> <span>数据结构</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title">
      数据库
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><!----> <span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/mysql-basic/" class="nav-link"><!----> <span>MySQL基础</span></a></li><li class="dropdown-subitem"><a href="/database/mysql.html" class="nav-link"><!----> <span>MySQL面试题</span></a></li><li class="dropdown-subitem"><a href="/database/mysql-execution-plan.html" class="nav-link"><!----> <span>MySQL执行计划详解</span></a></li></ul></li><li class="dropdown-item"><h4>
          非关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/redis-basic.html" class="nav-link"><!----> <span>Redis基础</span></a></li><li class="dropdown-subitem"><a href="/redis/redis.html" class="nav-link"><!----> <span>Redis面试题</span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/Ffb8NDgavf9QAWYBm0qAVg" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>ElasticSearch面试题</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><!----> <span class="title">
      分布式
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><!----> <span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/global-unique-id.html" class="nav-link"><!----> <span>全局唯一ID</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/distributed-lock.html" class="nav-link"><!----> <span>分布式锁</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/rpc.html" class="nav-link"><!----> <span>RPC</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/micro-service.html" class="nav-link"><!----> <span>微服务</span></a></li><li class="dropdown-item"><!----> <a href="/distributed/distributed-transaction.html" class="nav-link"><!----> <span>分布式事务</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程内功" class="dropdown-title"><!----> <span class="title">
      编程内功
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="编程内功" class="mobile-dropdown-title"><!----> <span class="title">编程内功</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advance/design-pattern.html" class="nav-link"><!----> <span>设计模式</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="场景题&amp;系统设计" class="dropdown-title"><!----> <span class="title">
      场景题&amp;系统设计
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="场景题&amp;系统设计" class="mobile-dropdown-title"><!----> <span class="title">场景题&amp;系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          海量数据
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mass-data/count-phone-num.html" class="nav-link"><!----> <span>统计不同号码的个数</span></a></li><li class="dropdown-subitem"><a href="/mass-data/find-hign-frequency-word.html" class="nav-link"><!----> <span>出现频率最高的100个词</span></a></li></ul></li><li class="dropdown-item"><h4>
          系统设计
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/system-design/scan-code-login.html" class="nav-link"><!----> <span>扫码登录设计</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title">
      工具
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><!----> <span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          开发工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/tools/git-overview.html" class="nav-link"><!----> <span>Git详解</span></a></li><li class="dropdown-subitem"><a href="/tools/maven-overview.html" class="nav-link"><!----> <span>Maven详解</span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/ATkZwtw4EF9erGJ4PamTjQ" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Docker详解</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/SKKEeYxif0wWJo6n57rd6A" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Nginx面试题</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://mp.weixin.qq.com/s/GbTaa3_qs1KvgUD3S2307w" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Linux常用命令</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          编程利器
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/tools/typora-overview.html" class="nav-link"><!----> <span>markdown编辑器</span></a></li></ul></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习资源" class="dropdown-title"><!----> <span class="title">
      学习资源
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="学习资源" class="mobile-dropdown-title"><!----> <span class="title">学习资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          学习资源
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/Tyson0314/java-books" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>计算机经典电子书PDF</span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="/learning-resources/leetcode-note.html" class="nav-link"><!----> <span>Leetcode刷题笔记</span></a></li></ul></li><li class="dropdown-item"><h4>
          学习路线
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/learning-resources/java-learn-guide.html" class="nav-link"><!----> <span>Java学习路线</span></a></li><li class="dropdown-subitem"><a href="/learning-resources/cs-learn-guide.html" class="nav-link"><!----> <span>CS学习路线</span></a></li></ul></li></ul></div></li><li class="nav-item"><a href="/other/site-diary.html" class="nav-link"><!----> <span>网站日记</span></a></li> <li class="nav-item"><a href="undefinedundefined/" target="_blank" rel="noopener noreferrer"><!----> <span></span> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><i></i> <span>简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/framework/netty-overview.html#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#netty-核心组件" class="sidebar-link">netty 核心组件</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#nio" class="sidebar-link">NIO</a></li></ul></li><li><a href="/framework/netty-overview.html#简单的-netty-应用程序" class="sidebar-link">简单的 netty 应用程序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#echo-服务器" class="sidebar-link">Echo 服务器</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#echo-客户端" class="sidebar-link">Echo 客户端</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#构建和运行-echo-服务器和客户端" class="sidebar-link">构建和运行 Echo 服务器和客户端</a></li></ul></li><li><a href="/framework/netty-overview.html#netty-的组件和设计" class="sidebar-link">Netty 的组件和设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channel-接口" class="sidebar-link">Channel 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#eventloop-接口" class="sidebar-link">EventLoop 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelfuture-接口" class="sidebar-link">ChannelFuture 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelhandler-2" class="sidebar-link">ChannelHandler</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelpipeline" class="sidebar-link">ChannelPipeline</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelinitializer" class="sidebar-link">ChannelInitializer</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#引导" class="sidebar-link">引导</a></li></ul></li><li><a href="/framework/netty-overview.html#传输" class="sidebar-link">传输</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#传输迁移" class="sidebar-link">传输迁移</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#传输-api" class="sidebar-link">传输 API</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#内置的传输" class="sidebar-link">内置的传输</a></li></ul></li><li><a href="/framework/netty-overview.html#bytebuf" class="sidebar-link">ByteBuf</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/framework/netty-overview.html#channelhandler-3" class="sidebar-link">ChannelHandler</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channel-的生命周期" class="sidebar-link">Channel 的生命周期</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelhandler-的生命周期" class="sidebar-link">ChannelHandler 的生命周期</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelinboundhandler-接口" class="sidebar-link">ChannelInboundHandler 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channeloutboundhandler-接口" class="sidebar-link">ChannelOutboundHandler 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelhandleradapter" class="sidebar-link">ChannelHandlerAdapter</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#资源管理" class="sidebar-link">资源管理</a></li></ul></li><li><a href="/framework/netty-overview.html#channelpipeline-接口" class="sidebar-link">ChannelPipeline 接口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#修改channelpipeline" class="sidebar-link">修改ChannelPipeline</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#channelhandlercontext-接口" class="sidebar-link">ChannelHandlerContext 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#异常处理" class="sidebar-link">异常处理</a></li></ul></li><li><a href="/framework/netty-overview.html#eventloop-和线程模型" class="sidebar-link">EventLoop 和线程模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#eventloop-接口-2" class="sidebar-link">EventLoop 接口</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#任务调度" class="sidebar-link">任务调度</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#实现细节" class="sidebar-link">实现细节</a></li></ul></li><li><a href="/framework/netty-overview.html#引导-2" class="sidebar-link">引导</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#引导客户端-2" class="sidebar-link">引导客户端</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#引导服务器-2" class="sidebar-link">引导服务器</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#在引导过程添加多个-channelhandler" class="sidebar-link">在引导过程添加多个 ChannelHandler</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#关闭" class="sidebar-link">关闭</a></li></ul></li><li><a href="/framework/netty-overview.html#编解码器" class="sidebar-link">编解码器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#解码器" class="sidebar-link">解码器</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#编码器" class="sidebar-link">编码器</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#编解码器类" class="sidebar-link">编解码器类</a></li></ul></li><li><a href="/framework/netty-overview.html#预置的-channelhandler-和编解码器" class="sidebar-link">预置的 ChannelHandler 和编解码器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#ssl-tls" class="sidebar-link">SSL/TLS</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#http-https-应用程序" class="sidebar-link">HTTP/HTTPS 应用程序</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#空闲的连接和超时" class="sidebar-link">空闲的连接和超时</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#基于分隔符的协议" class="sidebar-link">基于分隔符的协议</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#基于长度的协议" class="sidebar-link">基于长度的协议</a></li><li class="sidebar-sub-header"><a href="/framework/netty-overview.html#写大型数据" class="sidebar-link">写大型数据</a></li></ul></li><li><a href="/framework/netty-overview.html#ctx-write-和-channel-write-的区别" class="sidebar-link">ctx.write() 和 channel().write() 的区别</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-vpx-content content__default"><h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <h3 id="netty-核心组件"><a href="#netty-核心组件" class="header-anchor">#</a> netty 核心组件</h3> <ul><li><p>Channel：传入和传出数据的载体，它可以连接或者断开连接。</p></li> <li><p>回调：操作完成后通知相关方。</p></li> <li><p>Future：提供了另一种在操作完成时通知应用程序的方式。</p></li> <li><p>事件和 ChannelHandler</p></li></ul> <h3 id="nio"><a href="#nio" class="header-anchor">#</a> NIO</h3> <p>当一个 socket 建立好之后，Thread 会把这个连接请求交给 Selector，Selector 会不断去遍历所有的 Socket，一旦有一个 Socket 建立完成，它就会通知 Thread，然后 Thread 处理完数据在返回给客户端，这个过程是不阻塞的。</p> <h2 id="简单的-netty-应用程序"><a href="#简单的-netty-应用程序" class="header-anchor">#</a> 简单的 netty 应用程序</h2> <p>Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务
器发送一个或多个消息，反过来，服务器又会将每个消息回送给客户端。</p> <h3 id="echo-服务器"><a href="#echo-服务器" class="header-anchor">#</a> Echo 服务器</h3> <p>所有的 netty 服务器都需要以下两个部分：</p> <ul><li>一个 ChannelHandler，实现服务器对接受的客户端的数据的处理</li> <li>引导服务器：配置服务器的启动代码，将服务器绑定到它要监听连接请求的端口上</li></ul> <h4 id="channelhandler-和业务逻辑"><a href="#channelhandler-和业务逻辑" class="header-anchor">#</a> ChannelHandler 和业务逻辑</h4> <p>Echo 服务器需要实现 ChannelInboundHandler 方法，定义响应入站事件的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ChannelHandler.Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> in <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;server reveived: &quot;</span> <span class="token operator">+</span> in<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将接受到的消息回传给发送者</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span>EMPTY_BUFFER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span>CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭channel</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ChannelHandler 有助于保持业务逻辑与网络处理代码的分离。</p> <h4 id="引导服务器"><a href="#引导服务器" class="header-anchor">#</a> 引导服务器</h4> <ol><li>服务器监听端口；</li> <li>配置 Channel，将有关的入站事件消息通知给 EchoServerHandler。</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EchoServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Usage: &quot;</span> <span class="token operator">+</span> <span class="token class-name">EchoServer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">&quot; &lt;port&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">EchoServer</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//nio传输的channel</span>
                    <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将serverHandler添加到自Channel的ChannelPipeline</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异步绑定到服务器，阻塞直到绑定成功</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="echo-客户端"><a href="#echo-客户端" class="header-anchor">#</a> Echo 客户端</h3> <p>Echo 客户端的功能：</p> <ol><li>连接到服务器；</li> <li>发送消息；</li> <li>接收服务器发送的消息；</li> <li>关闭连接。</li></ol> <h4 id="channelhandler"><a href="#channelhandler" class="header-anchor">#</a> ChannelHandler</h4> <p>客户端也需要实现 ChannelInboundHandler，用于处理数据。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ChannelHandler.Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//当被通知的channel是活跃的时候发送消息</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Netty rocks!&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 每当接收数据就会调用此方法，服务器发送的数据可能被分块接收
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;client received: &quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收的消息</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="引导客户端"><a href="#引导客户端" class="header-anchor">#</a> 引导客户端</h4> <p>客户端使用主机和端口参数来连接远程地址。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EchoClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//适用于nio传输的channel类型</span>
                    <span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接到远程节点，阻塞等待</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞直到channel关闭</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭线程池并释放所有的资源</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Usage: &quot;</span> <span class="token operator">+</span> <span class="token class-name">EchoClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">&quot; &lt;host&gt; &lt;port&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> host <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">EchoClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="构建和运行-echo-服务器和客户端"><a href="#构建和运行-echo-服务器和客户端" class="header-anchor">#</a> 构建和运行 Echo 服务器和客户端</h3> <p>在服务器端，使用<code>mvn clean package</code>构建项目，然后在 idea 中配置 Edit Configurations，带参数运行服务器程序。</p> <p>同理，客户端进行同样的配置，注意带多个参数的运行配置，参数中间使用空格隔开。</p> <p>先运行服务器程序，在运行客户端程序，服务端接收到客户端发出的消息，控制台输出：<code>server reveived: Netty rocks!</code>，然后服务端将消息回传客户端，客户端控制台输出：<code>client received: Netty rocks!</code>，之后客户端便退出。</p> <h2 id="netty-的组件和设计"><a href="#netty-的组件和设计" class="header-anchor">#</a> Netty 的组件和设计</h2> <p>Channel -- Socket；</p> <p>EventLoop -- 控制流、多线程处理、并发；</p> <p>ChannelFuture -- 异步通知；</p> <p>ChannelHandler -- 处理出站和入站数据；</p> <h3 id="channel-接口"><a href="#channel-接口" class="header-anchor">#</a> Channel 接口</h3> <p>Netty 的Channel 接口所提供的API，大大地降低了直接使用Socket 类的复杂性。</p> <h3 id="eventloop-接口"><a href="#eventloop-接口" class="header-anchor">#</a> EventLoop 接口</h3> <p>EventLoop 用于处理连接的生命周期中所发生的事件。</p> <p>Channel 和 EventLoop 的关系：Channel 会被注册到 EventLoop 上，在整个生命周期内使用 EventLoop 处理 io 事件。</p> <p>一个EventLoop 在它的生命周期内只和一个Thread 绑定；</p> <p>一个Channel 在它的生命周期内只注册于一个EventLoop；</p> <p>一个EventLoop 可能会被分配给一个或多个Channel；</p> <p>一个给定 Channel 的I/O 操作都是由相同的Thread 执行的，实际上消除了对于同步的需要。</p> <h3 id="channelfuture-接口"><a href="#channelfuture-接口" class="header-anchor">#</a> ChannelFuture 接口</h3> <p>Netty 中所有 io 操作都是异步的，ChannelFuture 接口用于在操作完成时得到通知。</p> <h3 id="channelhandler-2"><a href="#channelhandler-2" class="header-anchor">#</a> ChannelHandler</h3> <p>ChannelHandler 的方法是由网络事件触发的。典型用途：</p> <ul><li>将数据从一种格式转换为另一种格式</li> <li>提供异常的通知</li> <li>提供Channel 变为活动的或者非活动的通知</li> <li>提供当Channel 注册到EventLoop 或者从EventLoop 注销时的通知</li> <li>提供有关用户自定义事件的通知</li></ul> <p>一些适配器类提供了 ChannelHandler 接口中的所有方法的默认实现。</p> <h3 id="channelpipeline"><a href="#channelpipeline" class="header-anchor">#</a> ChannelPipeline</h3> <p>提供了 ChannelHandler 链的容器。当 Channel 被创建时，会被自动分配到它专属的 ChannelPipeline。</p> <p>每一个事件都会流经 ChannelPipeline，被 ChannelHandler链处理，每一个 ChannelHandler 处理完数据会负责把事件传递给下一个 ChannelHandler，它们的顺序即是它们被安装的顺序。</p> <p>从客户端应用程序角度来看，如果事件从客户端传递到服务端，那么称之为出站事件，反之则是入站事件。从服务端角度来看则相反。Netty 能区分 ChannelInboundHandler 和 ChannelOutboundHandler 实现，并确保数据在能在具有相同类型的 ChannelHandler 之间传递。</p> <p>当ChannelHandler 被添加到ChannelPipeline 时，它将会被分配一个ChannelHandlerContext，其代表了ChannelHandler 和ChannelPipeline 之间的绑定。虽然这个对象可以被用于获取底层的Channel，但是它主要还是被用于写出站数据。</p> <h3 id="channelinitializer"><a href="#channelinitializer" class="header-anchor">#</a> ChannelInitializer</h3> <p>作用是给 ChannelPipeline 安装 ChannelHandler。</p> <p>ChannelHandler 安装到 ChannelPipeline 的过程：</p> <ul><li>一个 ChannelInitializer 的实现被注册到了 ServerBootstrap；</li> <li>当ChannelInitializer.initChannel()方法被调用时，ChannelInitializer 将在 ChannelPipeline 中安装ChannelHandler；</li> <li>ChannelInitializer 将它自己从ChannelPipeline 中移除。</li></ul> <h3 id="引导"><a href="#引导" class="header-anchor">#</a> 引导</h3> <p>Bootstrap 连接远程主机和端口，有一个 EventLoopGroup；ServerBootstrap 绑定到一个本地端口，有两个 EventLoopGroup。</p> <h2 id="传输"><a href="#传输" class="header-anchor">#</a> 传输</h2> <h3 id="传输迁移"><a href="#传输迁移" class="header-anchor">#</a> 传输迁移</h3> <p>Netty 为所有的传输提供了通用的 API，使得从阻塞传输到非阻塞传输的转换变得更加简单。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyNioServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;hi!\r\n&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//oio--&gt;nio</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//oio--&gt;nio</span>
                    <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInboundHandlerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                                    ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span>CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//绑定服务器以接受连接</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>只需要改动 SocketChannel 和 EventLoopGroup。</p> <h3 id="传输-api"><a href="#传输-api" class="header-anchor">#</a> 传输 API</h3> <p>每个 ChannelHandler 都会分配一个 ChannelPipeline 和 ChannelConfig。ChannelConfig 包含了该 Channel 的所有配置设置，并且支持热更新。</p> <p>可以通过向 ChannelPipeline 添加 ChannelHandler 实例来增加应用程序的功能。</p> <h3 id="内置的传输"><a href="#内置的传输" class="header-anchor">#</a> 内置的传输</h3> <p>Channel 被注册到选择器 Selector 后，当 Channel 状态发生变化时可以得到通知。可能的状态变化有：</p> <ul><li>新的 Channel 已被接受并且就绪；</li> <li>Channel 连接已经完成；</li> <li>Channel 有已经就绪的可供读取的数据；</li> <li>Channel 可用于写数据。</li></ul> <blockquote><p>零拷贝（zero-copy）是一种目前只有在使用NIO 和Epoll 传输时才可使用的特性。它使你可以快速
高效地将数据从文件系统移动到网络接口，而不需要将其从内核空间复制到用户空间，其在像FTP 或者
HTTP 这样的协议中可以显著地提升性能。它只能传输文件的原始内容，不能传输加密或者压缩的文件。</p></blockquote> <h4 id="epoll"><a href="#epoll" class="header-anchor">#</a> Epoll</h4> <p>用于 Linux 的本地非阻塞传输。Netty为Linux提供了一组NIO API，其以一种和它本身的设计更加一致的方式使用epoll，并且以一种更加轻量的方式使用中断。</p> <h2 id="bytebuf"><a href="#bytebuf" class="header-anchor">#</a> ByteBuf</h2> <p>Java NIO 提供了ByteBuffer 作为它的字节容器，但是这个类使用起来过于复杂，而且也有些繁琐。Netty 的ByteBuffer 替代品是ByteBuf，一个强大的实现，既解决了JDK API 的局限性，又为网络应用程序的开发者提供了更好的API。</p> <h4 id="upooled-缓冲区"><a href="#upooled-缓冲区" class="header-anchor">#</a> Upooled 缓冲区</h4> <p>Upooled 工具类提供了静态的辅助方法来创建未池化的 ByteBuf 实例。</p> <h2 id="channelhandler-3"><a href="#channelhandler-3" class="header-anchor">#</a> ChannelHandler</h2> <h3 id="channel-的生命周期"><a href="#channel-的生命周期" class="header-anchor">#</a> Channel 的生命周期</h3> <table><thead><tr><th>状态</th> <th>描述</th></tr></thead> <tbody><tr><td>ChannelUnregistered</td> <td>Channel 已创建，但还未注册到 EventLoop</td></tr> <tr><td>ChannelRegistered</td> <td>Channel 已注册到了 EventLoop</td></tr> <tr><td>ChannelActive</td> <td>Channel 已经连接到它的远程节点，可以接受和发送数据</td></tr> <tr><td>ChannelInactive</td> <td>Channel 没有连接到远程节点</td></tr></tbody></table> <p>正常的生命周期：</p> <p>ChannelRegistered -&gt; ChannelActive -&gt; ChannelInactive -&gt; ChannelUnregistered</p> <h3 id="channelhandler-的生命周期"><a href="#channelhandler-的生命周期" class="header-anchor">#</a> ChannelHandler 的生命周期</h3> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>handlerAdded</td> <td>把ChanneHandler添加到ChannelPipeline时被调用</td></tr> <tr><td>handlerRemoved</td> <td>从ChannelPipeline中移除ChannelHandler时被调用</td></tr> <tr><td>exceptionCaught</td> <td>处理过程中在ChannelPipeline中有错误产生时被调用</td></tr></tbody></table> <h3 id="channelinboundhandler-接口"><a href="#channelinboundhandler-接口" class="header-anchor">#</a> ChannelInboundHandler 接口</h3> <p>处理入站数据以及各种状态变化。</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>channelRead</td> <td>从Channel读取数据时被调用</td></tr> <tr><td>channelReadComplete</td> <td>从Channel上一个读操作完成时被调用</td></tr> <tr><td>channelWritablityChanged</td> <td>Channel 的可写状态发生改变时被调用</td></tr> <tr><td>userEventTriggered</td> <td>当ChannelnboundHandler.fireUserEventTriggered()方法被调用时被调用，因为一个POJO 被传经了ChannelPipeline</td></tr></tbody></table> <p>ReferenceCountUtil 释放消息资源：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscardHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>SimpleChannelInboundHandler 会自动释放资源，所以不应该存储指向任何消息的引用供将来使用，因为这些引用都将会失效。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleDiscardHandler</span>
        <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
                             <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No need to do anything special</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="channeloutboundhandler-接口"><a href="#channeloutboundhandler-接口" class="header-anchor">#</a> ChannelOutboundHandler 接口</h3> <p>ChannelOutboundHandler 一个强大的功能是可以按需推迟操作或者事件。</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>bind(ChannelHandlerContext, SocketAddress, ChannelPromise)</td> <td>当请求将Channel绑定到本地地址时被调用</td></tr> <tr><td>connect(ChannelHandlerContext, SocketAddress, ChannelPromise)</td> <td>当请求连接到远程节点时被调用</td></tr> <tr><td>close(ChannelHandlerContext, ChannelPromise)</td> <td>当请求关闭Channel时被调用</td></tr> <tr><td>deregister(ChannelHandlerContext, ChannelPromise)</td> <td>当请求将Channel 从它的EventLoop 注销时被调用</td></tr> <tr><td>read(ChannelHandlerContext)</td> <td>当请求从Channel 读取更多的数据时被调用</td></tr> <tr><td>flush(ChannelHandlerContext)</td> <td>当请求通过Channel 将入队数据冲刷到远程节点时被调用</td></tr> <tr><td>write(ChannelHandlerContext, Object, ChannelPromise)</td> <td>当请求通过Channel 将数据写到远程节点时被调用</td></tr></tbody></table> <p>ChannelPromise 是 ChannelFuture 的一个子类，ChannelOutboundHandler 中的大部分方法都需要一个 ChannelPromise参数，以便在操作完成时得到通知。</p> <h3 id="channelhandleradapter"><a href="#channelhandleradapter" class="header-anchor">#</a> ChannelHandlerAdapter</h3> <p>ChannelHandlerAdapter 提供了实用方法 isSharable()，如果其对应的实现被标注成 @Sharable，那么这个方法将返回true，表示它可以被添加到多个 ChannelPipeline 中。</p> <p>共享 ChannelHandler 一个常见的用途是用于收集跨越多个 channel 的统计信息。</p> <h3 id="资源管理"><a href="#资源管理" class="header-anchor">#</a> 资源管理</h3> <p>idea 配置 edit configuration -- vm options --  <code>-Dio.netty.leakDetectionLevel=ADVANCED</code></p> <h2 id="channelpipeline-接口"><a href="#channelpipeline-接口" class="header-anchor">#</a> ChannelPipeline 接口</h2> <p>每一个新创建的 Channel 都将会被分配一个新的 ChannelPipeline，这项关联是永久性的；Channel 既不能附加另外一个ChannelPipeline，也不能分离其当前的。</p> <p>ChannelHandlerContext 使得 ChannelHandler 能够和它的 ChannelPipeline 以及其他的 ChannelHandler 交互。</p> <h3 id="修改channelpipeline"><a href="#修改channelpipeline" class="header-anchor">#</a> 修改ChannelPipeline</h3> <p>ChannelHandler 可以通过添加、删除或者替换其他的ChannelHandler 来实时地修改ChannelPipeline 的布局。</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>addFirst/addBefore/addAfter/addLast</td> <td>将 ChannelHandler 添加到 ChannelPipeline</td></tr> <tr><td>remove</td> <td>移除</td></tr> <tr><td>replace</td> <td>替换</td></tr></tbody></table> <p>ChannelPipeline 的用于访问ChannelHandler 的操作：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>get</td> <td>返回ChannelHandler</td></tr> <tr><td>context</td> <td>返回和ChannelHandler绑定的ChannelHandlerContext</td></tr> <tr><td>names</td> <td>返回所有的ChannelHanlder名称</td></tr></tbody></table> <h3 id="channelhandlercontext-接口"><a href="#channelhandlercontext-接口" class="header-anchor">#</a> ChannelHandlerContext 接口</h3> <p>ChannelHandlerContext 代表了ChannelHandler 和ChannelPipeline 之间的关联，每当有ChannelHandler 添加到ChannelPipeline 中时，都会创建ChannelHandlerContext。</p> <p><img src="http://img.dabin-coder.cn/image/netty1.png" alt=""></p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>fireChannelRead</td> <td>触发对下一个ChannelInboundHandler的channelRead()方法的调用</td></tr> <tr><td>alloc</td> <td>返回相关联的Channel所配置的ByteBufAllocator</td></tr> <tr><td>bind</td> <td>绑定到给定的SocketAddress，并返回ChannelFuture</td></tr></tbody></table> <h3 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h3> <p>入站异常：在 ChannelInboundHandler 实现 exceptionCaught 方法。</p> <p>出站异常：</p> <p>1.添加ChannelFutureListener 到ChannelFuture</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>someMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> operationComplete <span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> f<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                f<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>2.添加ChannelFutureListener 到ChannelPromise：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutboundExceptionHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span>
                      <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    f<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="eventloop-和线程模型"><a href="#eventloop-和线程模型" class="header-anchor">#</a> EventLoop 和线程模型</h2> <h3 id="eventloop-接口-2"><a href="#eventloop-接口-2" class="header-anchor">#</a> EventLoop 接口</h3> <p>EventLoop 构建在 java.util.concurrent 和 io.netty.channel 之上。EventLoop 继承了 ScheduledExecutorService。EventLoop 由一个永远不会改变的 Thread 驱动，同时任务可以直接提交给 EventLoop 实现。EventLoop 可能服务于多个 Channel。</p> <p>Netty4中所有的 io 操作和事件都由 EventLoop 的 Thread 处理。Netty3只保证入站事件在 EventLoop（io 线程）执行，所有出站事件都由调用线程处理，可能是 io 线程或者别的线程，因此需要在 ChannelHandler 中对出站事件进行同步。</p> <p>Netty 4 中所采用的线程模型，通过在同一个线程中处理某个给定的EventLoop 中所产生的所有事件，解决了这个问题。这提供了一个更加简单的执行体系架构，并且消除了在多个ChannelHandler 中进行同步的需要</p> <h3 id="任务调度"><a href="#任务调度" class="header-anchor">#</a> 任务调度</h3> <p>使用 EventLoop 调度任务：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Channel</span> ch <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>
	<span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//逻辑</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>周期性任务：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Channel</span> ch <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
	<span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//逻辑</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDES<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="实现细节"><a href="#实现细节" class="header-anchor">#</a> 实现细节</h3> <p><img src="http://img.dabin-coder.cn/image/netty-eventloop%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91.png" alt=""></p> <h2 id="引导-2"><a href="#引导-2" class="header-anchor">#</a> 引导</h2> <p>配置 netty 应用程序，使它运行起来。服务器使用一个父 Channel 接受来自客户端的连接，并创建子 Channel 以用于它们之间的通信。客户端只需要一个 Channel 完成所有的网络交互。</p> <p>引导类是 cloneable 的，在引导类实例上调用 clone() 就可以创建多个具有类似配置或者完全相同配置的 Channel。</p> <h3 id="引导客户端-2"><a href="#引导客户端-2" class="header-anchor">#</a> 引导客户端</h3> <p>BootStrap 类被用于客户端或者使用了无连接协议的应用程序中。</p> <h3 id="引导服务器-2"><a href="#引导服务器-2" class="header-anchor">#</a> 引导服务器</h3> <p><img src="http://img.dabin-coder.cn/image/ServerBoostrap%E5%92%8CServerChannel.png" alt=""></p> <p>在基类AbstractBootstrap有handler方法，目的是添加一个handler，监听Bootstrap的动作。</p> <p>在服务端的ServerBootstrap中增加了一个方法childHandler，它的目的是添加handler，用来监听已经连接的客户端的Channel的动作和状态。</p> <p><strong>handler在初始化时就会执行，而childHandler会在客户端成功connect后才执行。</strong></p> <h3 id="在引导过程添加多个-channelhandler"><a href="#在引导过程添加多个-channelhandler" class="header-anchor">#</a> 在引导过程添加多个 ChannelHandler</h3> <p>在 handler 传入 ChannelInitializer 的实现类，重写 initChannel 方法，在这个方法中添加多个 ChannelHandler。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//适用于nio传输的channel类型</span>
        <span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接到远程节点，阻塞等待</span>
    future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞直到channel关闭</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭线程池并释放所有的资源</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="关闭"><a href="#关闭" class="header-anchor">#</a> 关闭</h3> <p>关闭 EventLoopGroup，它将处理任何挂起的事件和任务，随后释放所有活动的线程。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放所有资源，关闭Channel</span>
<span class="token comment">// block until the group has shutdown</span>
future<span class="token punctuation">.</span><span class="token function">syncUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="编解码器"><a href="#编解码器" class="header-anchor">#</a> 编解码器</h2> <p>数据格式转化。编码器操作出站数据，解码器处理入站数据。继承自 ChannelInboundHandlerAdapter。数据编码或者解码完就会被传入 ChannelPipeline 的下一个 ChannelHandler。</p> <h3 id="解码器"><a href="#解码器" class="header-anchor">#</a> 解码器</h3> <p>ByteToMessageDecoder、ReplayingDecoder：将字节解码为消息。</p> <p>MessageToMessageDecoder：将消息解码为另一种消息。</p> <h4 id="抽象类-bytetomessagedecoder"><a href="#抽象类-bytetomessagedecoder" class="header-anchor">#</a> 抽象类 ByteToMessageDecoder</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToIntegerDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>调用 readInt() 方法前需要验证输入的 ByteBuf 是否具有足够的数据。</p> <h4 id="抽象类-replayingdecoder"><a href="#抽象类-replayingdecoder" class="header-anchor">#</a> 抽象类 ReplayingDecoder</h4> <p>类型参数S 指定了用于状态管理的类型，其中Void 代表不需要状态管理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToIntegerDecoder2</span> <span class="token keyword">extends</span> <span class="token class-name">ReplayingDecoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果没有足够的字节可用，这个readInt()方法的实现将会抛出一个Error，将在基类中被捕获并处理。当有更多的数据可供读取时，该decode()方法将会被再次调用。</p> <p>并不是所有的ByteBuf 操作都被支持，如果调用了一个不被支持的方法，将会抛出一个UnsupportedOperationException；ReplayingDecoder 稍慢于ByteToMessageDecoder。如果使用ByteToMessageDecoder 不会引入太多的复杂性，那么选用它。</p> <h4 id="抽象类-messagetomessagedecoder"><a href="#抽象类-messagetomessagedecoder" class="header-anchor">#</a> 抽象类 MessageToMessageDecoder</h4> <p>两种消息格式的转换。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegerToStringDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToMessageDecoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">Integer</span> integer<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="toolongframeexception-类"><a href="#toolongframeexception-类" class="header-anchor">#</a> TooLongFrameException 类</h4> <p>解码器缓冲大量的数据以至于耗尽可用的内存，可以设置一个最大字节数的阈值，如果超出该阈值，则手动抛出一个TooLongFrameException。</p> <h3 id="编码器"><a href="#编码器" class="header-anchor">#</a> 编码器</h3> <p>消息编码为字节；消息编码为消息。</p> <h4 id="抽象类-messagetobyteencoder"><a href="#抽象类-messagetobyteencoder" class="header-anchor">#</a> 抽象类 MessageToByteEncoder</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShortToByteEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Short</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Short</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="抽象类-messagetomessageencoder"><a href="#抽象类-messagetomessageencoder" class="header-anchor">#</a> 抽象类 MessageToMessageEncoder</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegerToStringEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToMessageEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Integer</span> msg
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="编解码器类"><a href="#编解码器类" class="header-anchor">#</a> 编解码器类</h3> <p>结合一个解码器和编码器可能会对可重用性造成影响。</p> <h4 id="抽象类-bytetomessagecodec"><a href="#抽象类-bytetomessagecodec" class="header-anchor">#</a> 抽象类 ByteToMessageCodec</h4> <p>结合了 ByteToMessageDecoder 和 MessageToByteEncoder。</p> <h4 id="抽象类-messagetomessagecodec"><a href="#抽象类-messagetomessagecodec" class="header-anchor">#</a> 抽象类 MessageToMessageCodec</h4> <p>定义：<code>public abstract class MessageToMessageCodec&lt;INBOUND_IN,OUTBOUND_IN&gt;</code></p> <h4 id="combinedchannelduplexhandler-类"><a href="#combinedchannelduplexhandler-类" class="header-anchor">#</a> CombinedChannelDuplexHandler 类</h4> <p>可以实现一个编解码器，而又不必直接扩展抽象的编解码器类。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CombinedChannelDuplexHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">,</span>
<span class="token class-name">O</span> e xtends <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ByteToCharDecoder 类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteToCharDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">readChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>CharToByteEncoder 类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CharToByteEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">Character</span> character<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        byteBuf<span class="token punctuation">.</span><span class="token function">writeChar</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//向byteBuf写入基本类型的值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>编解码器类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CombinedByteCharCodec</span> <span class="token keyword">extends</span> <span class="token class-name">CombinedChannelDuplexHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteToCharDecoder</span><span class="token punctuation">,</span> <span class="token class-name">CharToByteEncoder</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span>  <span class="token class-name">CombinedByteCharCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteToCharDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CharToByteEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将委托实例传递给父类</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="预置的-channelhandler-和编解码器"><a href="#预置的-channelhandler-和编解码器" class="header-anchor">#</a> 预置的 ChannelHandler 和编解码器</h2> <h3 id="ssl-tls"><a href="#ssl-tls" class="header-anchor">#</a> SSL/TLS</h3> <p>Java 提供了 javax.net.ssl 支持 SSL/TSL，用以实现数据安全。</p> <p><img src="http://img.dabin-coder.cn/image/sslhandler%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt=""></p> <p>添加 SSL/TLS 支持：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SslChannelInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SslContext</span> context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> startTls<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SslChannelInitializer</span><span class="token punctuation">(</span><span class="token class-name">SslContext</span> context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> startTls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startTls <span class="token operator">=</span> startTls<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SSLEngine</span> engine <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">newEngine</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//alloc返回channel所配置的ByteBufAllocator</span>
        channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token string">&quot;ssl&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SslHandler</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> startTls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//大多数情况SslHandler是第一个ChannelHandler</span>
                                                  <span class="token comment">//这确保了所有其他的ChannelHandler处理数据之后，才会进行加密。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="http-https-应用程序"><a href="#http-https-应用程序" class="header-anchor">#</a> HTTP/HTTPS 应用程序</h3> <p>完整的 HTTP 请求（FullHttpRequest）包括请求头信息、若干个 HTTPContent 和 LastHttpContent。</p> <p>完整的 HTTP 响应（FullHttpResponse）包括响应头信息、若干个 HTTPContent 和 LastHttpContent。</p> <p>所有类型的 HTTP 消息都实现了 HttpObject 接口。</p> <p>HTTP 编解码器：HttpRequestEncoder、HttpResponseEncoder、HttpReqeustDecoder 和 HttpResponseDecoder。</p> <p>HttpResponseDecoder：将字节解码为 HttpResponse、HttpContent 和 LastHttpContent。</p> <h4 id="添加-http-支持"><a href="#添加-http-支持" class="header-anchor">#</a> 添加 HTTP 支持</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpPipelineInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> client<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HttpPipelineInitializer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpResponseDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpResponseEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>判断是否是客户端，如果是客户端，则添加 HttpResponseDecoder 对服务器响应进行解码。</p> <h4 id="聚合-http-消息"><a href="#聚合-http-消息" class="header-anchor">#</a> 聚合 HTTP 消息</h4> <p>由于 HTTP 请求和响应可能由多个部分组成，需要将它们聚合成完整的消息。Netty 提供了一个聚合器，可以将多个消息部分合并成 FullHttpRequest 或者 FullHttpResponse 消息。</p> <p>自动聚合 HTTP 的消息片段：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpAggregarotInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HttpAggregarotInitializer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isClient <span class="token operator">=</span> isClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpClientCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;aggregator&quot;</span><span class="token punctuation">,</span> <span class="token comment">//最大消息大小是512kb</span>
                <span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>HttpServerCodec 里面组合了HttpResponseEncoder和HttpRequestDecoder。</p> <p>HttpClientCodec 里面组合了HttpRequestEncoder和HttpResponseDecoder。</p> <h4 id="http-压缩"><a href="#http-压缩" class="header-anchor">#</a> HTTP 压缩</h4> <p>当使用HTTP 时，建议服务器端开启压缩功能以尽可能多地减小传输数据的大小。Netty 为压缩和解压缩提供了ChannelHandler 实现，它们同时支持gzip 和deflate 编码。</p> <p>自动压缩 HTTP 消息：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpCompressionInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isClient<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">HttpCompressionInitializer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isClient <span class="token operator">=</span> isClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpClientCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decompressor&quot;</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HttpContentDecompressor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理来自服务器的压缩内容</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;compressor&quot;</span><span class="token punctuation">,</span> 
                    <span class="token keyword">new</span> <span class="token class-name">HttpContentCompressor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//服务器端压缩数据</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="https"><a href="#https" class="header-anchor">#</a> HTTPS</h4> <p>启动 HTTPS 只需要将 SslHandler 添加到 ChannelPipeline。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpsCodecInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SslContext</span> context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isClient<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">HttpsCodecInitializer</span><span class="token punctuation">(</span><span class="token class-name">SslContext</span> context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isClient <span class="token operator">=</span> isClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SSLEngine</span> engine <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">newEngine</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token string">&quot;ssl&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SslHandler</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加SslHandler之后可以使用https</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpClientCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;codec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h4> <p>WebSocket 在客户端和服务器之间提供了真正的双向数据交换。</p> <p><img src="http://img.dabin-coder.cn/image/netty-websocket%E5%8D%8F%E8%AE%AE.png" alt=""></p> <p>WebSocketFrame 类型：</p> <table><thead><tr><th>名称</th> <th>描述</th></tr></thead> <tbody><tr><td>BinaryWebSocketFrame</td> <td>二进制数据帧</td></tr> <tr><td>TextWebSocketFrame</td> <td>文本数据帧</td></tr> <tr><td>ContinuationWebSocketFrame</td> <td>二进制和文本数据帧结合体</td></tr> <tr><td>CloseWebSocketFrame</td> <td>控制帧：一个close请求、关闭的状态码以及关闭的原因</td></tr> <tr><td>PingWebSocketFrame</td> <td>控制帧：请求一个PongWebSocketFrame</td></tr> <tr><td>PongWebSocketFrame</td> <td>控制帧：对PingWebSocketFrame请求的响应</td></tr></tbody></table> <p>WebSocketServerProtocolHandler 处理协议升级握手，以及三种控制帧--Close、Ping 和 Pong。Text和Binary数据帧将会被传递给下一个 ChannelHandler 进行处理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketServerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">WebSocketServerProtocolHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//升级握手</span>
                <span class="token keyword">new</span> <span class="token class-name">TextFrameHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">BinaryFrameHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ContinuationFrameHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TextFrameHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">TextWebSocketFrame</span> textWebSocketFrame<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//handle text frame</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BinaryFrameHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BinaryWebSocketFrame</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">BinaryWebSocketFrame</span> binaryWebSocketFrame<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//handle binary frame</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ContinuationFrameHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ContinuationWebSocketFrame</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ContinuationWebSocketFrame</span> continuationWebSocketFrame<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//handle continuation frame</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><blockquote><p>要想为WebSocket 添加安全性，只需要将SslHandler 作为第一个ChannelHandler 添加到ChannelPipeline 中。</p></blockquote> <h3 id="空闲的连接和超时"><a href="#空闲的连接和超时" class="header-anchor">#</a> 空闲的连接和超时</h3> <p>用于空闲连接以及超时的 ChannelHandler。</p> <p><img src="http://img.dabin-coder.cn/image/%E7%94%A8%E4%BA%8E%E7%A9%BA%E9%97%B2%E8%BF%9E%E6%8E%A5%E4%BB%A5%E5%8F%8A%E8%B6%85%E6%97%B6%E7%9A%84ChannelHandler.png" alt=""></p> <p>发送心跳：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdleStateHandlerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//60s没有接受或发送数据，IdelStateHandler会使用IdleStateEvent调用fireUserEventTriggered()</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartbeatHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeartbeatHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送到远程节点的心跳信息</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> HEARTBEAT_SEQUENCE <span class="token operator">=</span>
                <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">unreleasableBuffer</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;HEARTBEAT&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span>ISO_8859_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token keyword">instanceof</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//连接空闲时间太长时，发送心跳消息，并在发送失败时关闭该连接</span>
                ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>HEARTBEAT_SEQUENCE<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span>CLOSE_ON_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//传递给下一个ChannelInboundHandler</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>使用 IdleStateHandler 测试远程节点是否还活着，失活时关闭连接释放资源。</p> <h3 id="基于分隔符的协议"><a href="#基于分隔符的协议" class="header-anchor">#</a> 基于分隔符的协议</h3> <p>基于分隔符的协议的解码器</p> <table><thead><tr><th>名称</th> <th>描述</th></tr></thead> <tbody><tr><td>DelimiterBasedFrameDecoder</td> <td>使用自定义分隔符提取帧的通用解码器</td></tr> <tr><td>LineBasedFrameDecoder</td> <td>提取由行尾符分隔的解码器，速度比DeimiterBasedFrameDecoder快</td></tr></tbody></table> <p>分隔符提取帧：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LineBasedHandlerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提取帧，并传给下一个ChannelHandler</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LineBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FrameHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收数据帧</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FrameHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//处理LineBasedFrameDecoder传进的帧</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>示例：1.每个帧都由换行符（\n）分隔；2.每个帧由一系列的元素组成，每个元素都由的单个空格字符分隔；3.一个帧内容代表一个命令，定义为一个命令名称后面跟着数目可变的参数。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CmdHandlerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> SPACE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token char">' '</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CmdDecoder</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CmdHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Cmd</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> args<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Cmd</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span> name<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> args<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CmdDecoder</span>
            <span class="token keyword">extends</span> <span class="token class-name">LineBasedFrameDecoder</span> <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token class-name">CmdDecoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>maxLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> buffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuf</span> frame <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//查找第一个空格字符的索引，空格前是命令名称，后面是参数</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    frame<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SPACE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Cmd</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    frame<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CmdHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cmd</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">Cmd</span> cmd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//处理cmd</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="基于长度的协议"><a href="#基于长度的协议" class="header-anchor">#</a> 基于长度的协议</h3> <p>基于长度的协议的解码器：</p> <table><thead><tr><th>名称</th> <th>描述</th></tr></thead> <tbody><tr><td>FixedLengthFrameDecoder</td> <td>提取固定长度的帧</td></tr> <tr><td>LengthFieldBasedFrameDecoder</td> <td>根据帧头部中的长度值提取帧；该字段的偏移量以及长度在构造函数中指定</td></tr></tbody></table> <p>变长帧：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LengthBasedInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeLine <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//帧起始的前8字节是帧长度</span>
        pipeLine<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LengthFieldBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeLine<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FrameHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FrameHandler</span> <span class="token keyword">extends</span>
            <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">//处理帧</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="写大型数据"><a href="#写大型数据" class="header-anchor">#</a> 写大型数据</h3> <p>当写大型数据到远程节点时，如果连接速度比较慢，数据依然不断的往内存写，可能导致内存耗尽。利用 NIO 的零拷贝特性，可以消除将文件内容从文件系统移动到网络栈的复制过程。应用程序需要做的就是实现一个 FileRegion 的接口。</p> <p>利用零拷贝特性（FileRegion）来传输一个文件的内容。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">FileInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FileRegion</span> region <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultFileRegion</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
	<span class="token keyword">new</span> <span class="token class-name">ChannelFuture</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
    	<span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="ctx-write-和-channel-write-的区别"><a href="#ctx-write-和-channel-write-的区别" class="header-anchor">#</a> ctx.write() 和 channel().write() 的区别</h2> <p>https://blog.csdn.net/lalalahaitang/article/details/81563830</p></div> <div class="page-edit"><!----> <span class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2022, 5:55:56 PM</span></span></div> <!----> <!----> </main> <!----></div><div class="global-ui"><div></div><div class="qrcode_container" data-v-131437c0><div class="tencent_code" data-v-131437c0><h4 data-v-131437c0>关注作者公众号</h4> <p data-v-131437c0>和万千小伙伴一起学习</p> <img src="/assets/img/gzh.375c9530.jpg" alt data-v-131437c0></div> <div class="group_code" data-v-131437c0><h4 data-v-131437c0>加入技术交流群</h4> <p data-v-131437c0>扫描二维码 备注<span data-v-131437c0> 技术群</span></p> <img src="/assets/img/wechat.d205276b.jpg" alt data-v-131437c0></div></div><!----><div></div></div></div>
    <script src="/assets/js/app.8b2696d1.js" defer></script><script src="/assets/js/2.d0db0f62.js" defer></script><script src="/assets/js/44.9d432355.js" defer></script><script src="/assets/js/4.23f6297f.js" defer></script><script src="/assets/js/3.1924df35.js" defer></script>
  </body>
</html>
